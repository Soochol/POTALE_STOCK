version: "1.0"

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 공통 조건 라이브러리 (YAML Anchors)
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
condition_presets:
  basic_surge_conditions:
    - &high_surge_rate
      name: "high_surge_rate"
      expression: "prev != None and ((current.high - prev.close) / prev.close) >= 0.10"
      description: "전날 종가 대비 당일 고가 상승률 10% 이상"

    - &trading_value_threshold
      name: "trading_value_threshold"
      expression: "current.trading_value >= 30000000000"
      description: "당일 거래대금 300억 이상"

    - &normalized_volume_surge
      name: "normalized_volume_surge"
      expression: "normalized_volume(60) >= 300.0"
      description: "거래량정규화 60일 기준 300% 이상"

block_graph:
  # 패턴 타입
  pattern_type: "seed"

  # 시작 블록
  root_node: "block1"

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # 블록 노드 정의
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  nodes:
    # ═══════════════════════════════════════════════════════
    # Block 1 - 대량 거래대금 + 거래량 급등
    # ═══════════════════════════════════════════════════════
    block1:
      block_id: "block1"
      block_type: 1
      name: "High Trading Value with Volume Surge"
      description: "거래대금 300억 이상 + 거래량 급등 패턴"

      # 진입 조건 (AND 조건: 모두 만족해야 함)
      entry_conditions:
        - *high_surge_rate
        - *trading_value_threshold
        - *normalized_volume_surge

      # NOTE: Block1은 시작 블록이므로 spot_condition과 spot_entry_conditions 불필요
      # spot_condition: "is_backward_spot('block1', -1, -2)"
      # spot_entry_conditions:
      #   - name: "current_high_greater_than_check_day"
      #     expression: "current and current.high > check_day.high"
      #   - name: "close_high_ratio"
      #     expression: "check_day and high_low_distance_ratio(check_day.close, current.high, current.low) >= 200"

      # 종료 조건 (OR 조건: 하나라도 만족하면 종료)
      exit_conditions:
        - name: "block2_started"
          expression: "exists('block2')"
          description: "Block2가 시작되면 Block1 자동 종료"

        - name: "max_duration_limit"
          expression: "candles_between(active_block.started_at, current.date) >= 180"
          description: "Block1 시작 후 180일 경과 시 자동 종료"

      # Forward Spot 조건 (NEW - 2025-10-26)
      # Block1이 시작된 후 D+1, D+2일에 조건을 만족하면 spot 추가
      forward_spot_condition: "is_forward_spot('block1', 1, 2)"

      # Forward Spot 진입 조건 (D+1, D+2일 평가용)
      spot_entry_conditions:
        - *high_surge_rate
        - *trading_value_threshold
        - *normalized_volume_surge

      # 재탐지 조건 (Block1 완료 후)
      reentry:
        # 재진입 조건 (AND 조건)
        entry_conditions:
          - name: "price_surge_from_prev_close"
            expression: "prev != None and current.high >= prev.close * 1.10"
            description: "전일 종가 대비 당일 고가 등락률 10% 이상"

          - name: "normalized_volume_surge"
            expression: "normalized_volume(60) >= 300.0"
            description: "거래량정규화 60일 기준 300% 이상"

          - name: "peak_price_similarity"
            expression: "within_range(current.high, parent_block.peak_price, 10.0)"
            description: "고점이 시드블록 고점 대비 +/-10% 이내"

        # 재진입 종료 조건 (OR 조건)
        exit_conditions:
          - name: "redetection_duration_limit"
            expression: "candles_between(active_redetection.started_at, current.date) >= 30"
            description: "재진입 시작 후 30일 경과"

    # ═══════════════════════════════════════════════════════
    # Block 2 -  double price surge from Block 1
    # ═══════════════════════════════════════════════════════
    block2:
      block_id: "block2"
      block_type: 2
      name: "Super Surge with Ultra High Trading Value"
      description: "거래대금 1000억 이상 + 전일 대비 3배 + 365일 신고가 + Block1 초과 (극강 조건)"

      # 진입 조건 (AND 조건: 모두 만족해야 함)
      entry_conditions:
        - name: "requires_block1"
          expression: "exists('block1')"
          description: "Block1이 존재해야 Block2 시작 가능 (순차적 패턴)"

        - *high_surge_rate
        - *trading_value_threshold
        - *normalized_volume_surge

        - name: "price_doubling_surge_from_block1"
          expression: "is_price_doubling_surge('block1')"
          description: "Block1의 상승폭(시작 전날 종가 → 최고가)을 Block1 최고가에서 반복 (2배 상승)"

      # 종료 조건 (OR 조건: 하나라도 만족하면 종료)
      exit_conditions:
        - name: "block3_started"
          expression: "exists('block3')"
          description: "Block3가 시작되면 Block2 자동 종료"

        - name: "max_duration_limit"
          expression: "candles_between(active_block.started_at, current.date) >= 180"
          description: "Block2 시작 후 180일 경과 시 자동 종료"

      # 재탐지 조건 (Block2 완료 후)
      reentry:
        # 재진입 조건 (AND 조건)
        entry_conditions:
          - name: "price_surge_from_prev_close"
            expression: "prev != None and current.high >= prev.close * 1.10"
            description: "전일 종가 대비 당일 고가 등락률 10% 이상"

          - name: "normalized_volume_surge"
            expression: "normalized_volume(60) >= 300.0"
            description: "거래량정규화 60일 기준 300% 이상"

          - name: "peak_price_similarity"
            expression: "within_range(current.high, parent_block.peak_price, 10.0)"
            description: "고점이 시드블록 고점 대비 +/-10% 이내"

        # 재진입 종료 조건 (OR 조건)
        exit_conditions:
          - name: "redetection_duration_limit"
            expression: "candles_between(active_redetection.started_at, current.date) >= 30"
            description: "재진입 시작 후 30일 경과"

      # Spot 조건 (선택적) - 회고적 spot 패턴 (NEW - 2025-10-25)
      # Block2 조건이 D일에 만족될 때, D-1, D-2일을 회고적으로 검사하여
      # spot_entry_conditions를 만족하는지 확인 (is_price_doubling_surge 제외)

      # Option 1: Stay Spot (Block1에 spot 추가, Block2 생성 안 함)
      # -1 = D-1일, -2 = D-2일 (음수 오프셋)
      # 스킵된 블록 재탐지 테스트용

      # Option 2: Levelup Spot (Block2 생성하되 시작일 조정, Block1 종료)
      # spot_condition:
      #   function: "is_levelup_spot"
      #   args:
      #     prev_block_id: "block1"
      #     min_days: 1
      #     max_days: 2
      #   exclude_conditions:
      #     - "price_doubling_surge_from_block1"

      spot_condition: "is_backward_spot('block1', -1, -2)"

      # Spot 진입 조건 (회고적 검사용, NEW - 2025-10-25)
      # D-1, D-2일에 평가할 조건 (is_price_doubling_surge 제외)
      spot_entry_conditions:
        - name: "high_gain_from_check_day"
          expression: "check_day and current.high >= check_day.high * 1.10"
          description: "검사일 고가 대비 당일 고가 10% 이상"

        - name: "low_not_too_low_from_check_day"
          expression: "check_day and current.low >= check_day.high * 0.95"
          description: "검사일 고가 대비 당일 저가 -5% 이내"

        - name: "mid_price_above_check_day"
          expression: "check_day and (current.high + current.low) / 2 > check_day.high"
          description: "중심가가 검사일 고가보다 위"

    # ═══════════════════════════════════════════════════════
    # Block 3 - 지속적인 강세 패턴
    # ═══════════════════════════════════════════════════════
    block3:
      block_id: "block3"
      block_type: 3
      name: "Sustained Momentum Pattern"
      description: "거래대금 300억 이상 + 거래량 급등 + Block2 이후 지속 패턴"

      # 진입 조건 (AND 조건: 모두 만족해야 함)
      entry_conditions:
        - name: "requires_block2"
          expression: "exists('block2')"
          description: "Block2가 존재해야 Block3 시작 가능 (순차적 패턴)"

        - *high_surge_rate
        - *trading_value_threshold
        - *normalized_volume_surge

        - name: "high_gain_from_block2"
          expression: "exists('block2') and current.high >= block2.peak_price * 1.10"
          description: "Block2 고점 대비 당일 고가 10% 이상"

        - name: "low_not_too_low_from_block2"
          expression: "exists('block2') and current.low >= block2.peak_price * 0.95"
          description: "Block2 고점 대비 당일 저가 -5% 이내"

        - name: "mid_price_above_block2"
          expression: "exists('block2') and (current.high + current.low) / 2 > block2.peak_price"
          description: "중심가가 Block2 고점보다 위"

      # 종료 조건 (OR 조건: 하나라도 만족하면 종료)
      exit_conditions:
        - name: "max_duration_limit"
          expression: "candles_between(active_block.started_at, current.date) >= 180"
          description: "Block3 시작 후 180일 경과 시 자동 종료"

      # Spot 조건 (선택적) - 회고적 spot 패턴
      spot_condition: "is_backward_spot('block2', -1, -2)"

      # Spot 진입 조건 (회고적 검사용)
      spot_entry_conditions:
        - name: "high_gain_from_check_day"
          expression: "check_day and current.high >= check_day.high * 1.10"
          description: "검사일 고가 대비 당일 고가 10% 이상"

        - name: "low_not_too_low_from_check_day"
          expression: "check_day and current.low >= check_day.high * 0.95"
          description: "검사일 고가 대비 당일 저가 -5% 이내"

        - name: "mid_price_above_check_day"
          expression: "check_day and (current.high + current.low) / 2 > check_day.high"
          description: "중심가가 검사일 고가보다 위"

      # 재탐지 조건 (Block3 완료 후)
      reentry:
        # 재진입 조건 (AND 조건)
        entry_conditions:
          - name: "price_surge_from_prev_close"
            expression: "prev != None and current.high >= prev.close * 1.10"
            description: "전일 종가 대비 당일 고가 등락률 10% 이상"

          - name: "normalized_volume_surge"
            expression: "normalized_volume(60) >= 300.0"
            description: "거래량정규화 60일 기준 300% 이상"

          - name: "peak_price_similarity"
            expression: "within_range(current.high, parent_block.peak_price, 10.0)"
            description: "고점이 시드블록 고점 대비 +/-10% 이내"

        # 재진입 종료 조건 (OR 조건)
        exit_conditions:
          - name: "redetection_duration_limit"
            expression: "candles_between(active_redetection.started_at, current.date) >= 30"
            description: "재진입 시작 후 30일 경과"

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # 블록 간 관계 (엣지)
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  edges:
    - from_block: "block1"
      to_block: "block2"
      edge_type: "sequential"
      priority: 1
      description: "Block1에서 Block2로 전이 (더 강한 급등 시)"

    - from_block: "block2"
      to_block: "block3"
      edge_type: "sequential"
      priority: 1
      description: "Block2에서 Block3로 전이 (지속적인 강세 패턴)"
